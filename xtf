#!/bin/bash
POSIXLY_CORRECT=yes

lastFlag=0
command=list
commandSet=0
after=""
afterSet=0
before=""
beforeSet=0
user=""
currency=()
files=()
output=""
margin=${XTF_PROFIT:-20}

setCommand(){

  case $1 in
    list)
      command=list
      ((commandSet++))
      return 0
    ;;
    
    list-currency)
      command=list-currency
      ((commandSet++))
      return 0
    ;;

    status)
      command=status
      ((commandSet++))
      return 0
    ;;

    profit)
      command=profit
      ((commandSet++))
      return 0
    ;;
  esac

  return 1
}

setFilters(){
  case $1 in
    -a)
      lastFlag=1
    ;;

    -b)
      lastFlag=2
    ;;

    -c)
      lastFlag=3
    ;;

    *)
      lastFlag=0
    ;;
  esac
}

filterUser(){
  output=$(echo "$output" | grep -h "$user")
}

filterCurrency() {
  if [ "$currency" == "" ]; then
    return
  fi

  local string=$(echo "$output" | awk -F';' -v currency="${currency[@]}" '
    BEGIN {
        split(currency, arr, " ");
        for (i in arr) {
            currencies[arr[i]] = 1;
        }
    }
    {
        if ($3 in currencies) {
            print $0;
        }
    }
  ')

  output="$string"

  # for curr in $currency; do
  #   matches=$(echo "$output" | grep -h "$curr")
  #   if [ -n "$matches" ]; then
  #     string+="$matches"$'\n'
  #   fi
  # done

  # output="${string%$'\n'}"
}

filterAfter(){
  if [ "$after" == "" ]; then 
    return
  fi


  local IFS=$'\n'
  for line in $output; do
    date=$(echo $line | awk -F ';' '{printf "%s", $2}')
    isAfter=$(echo "$date" | awk -v afterDate="$after" '{split($0, date, /[- :]/);
      isValid = 1;

      if (date[1] > substr(afterDate, 1, 4)) {
        isValid = 0;
      } else if (date[1] == substr(afterDate, 1, 4) && date[2] > substr(afterDate, 6, 2)) {
        isValid = 0;
      } else if (date[1] == substr(afterDate, 1, 4) && date[2] == substr(afterDate, 6, 2) && date[3] > substr(afterDate, 9, 2)) {
        isValid = 0;
      } else if (date[1] == substr(afterDate, 1, 4) && date[2] == substr(afterDate, 6, 2) && date[3] == substr(afterDate, 9, 2) && date[4] > substr(afterDate, 12, 2)) {
        isValid = 0;
      } else if (date[1] == substr(afterDate, 1, 4) && date[2] == substr(afterDate, 6, 2) && date[3] == substr(afterDate, 9, 2) && date[4] == substr(afterDate, 12, 2) && date[5] > substr(afterDate, 15, 2)) {
        isValid = 0;
      } else if (date[1] == substr(afterDate, 1, 4) && date[2] == substr(afterDate, 6, 2) && date[3] == substr(afterDate, 9, 2) && date[4] == substr(afterDate, 12, 2) && date[5] == substr(afterDate, 15, 2) && date[6] >= substr(afterDate, 18, 2)) {
        isValid = 0;
      }

      print isValid;
    }')

    if [ $isAfter == 1 ]; then
      output=$(echo "$output" | grep -v "$date")
    fi
  done
}

filterBefore(){
  if [ "$before" == "" ]; then 
    return
  fi

  local IFS=$'\n'
  for line in $output; do
    date=$(echo $line | awk -F ';' '{printf "%s", $2}')
    isBefore=$(echo "$date" | awk -v beforeDate="$before" '{split($0, date, /[- :]/);
      isValid = 0;

      if (date[1] > substr(beforeDate, 1, 4)) {
        isValid = 1;
      } else if (date[1] == substr(beforeDate, 1, 4) && date[2] > substr(beforeDate, 6, 2)) {
        isValid = 1;
      } else if (date[1] == substr(beforeDate, 1, 4) && date[2] == substr(beforeDate, 6, 2) && date[3] > substr(beforeDate, 9, 2)) {
        isValid = 1;
      } else if (date[1] == substr(beforeDate, 1, 4) && date[2] == substr(beforeDate, 6, 2) && date[3] == substr(beforeDate, 9, 2) && date[4] > substr(beforeDate, 12, 2)) {
        isValid = 1;
      } else if (date[1] == substr(beforeDate, 1, 4) && date[2] == substr(beforeDate, 6, 2) && date[3] == substr(beforeDate, 9, 2) && date[4] == substr(beforeDate, 12, 2) && date[5] > substr(beforeDate, 15, 2)) {
        isValid = 1;
      } else if (date[1] == substr(beforeDate, 1, 4) && date[2] == substr(beforeDate, 6, 2) && date[3] == substr(beforeDate, 9, 2) && date[4] == substr(beforeDate, 12, 2) && date[5] == substr(beforeDate, 15, 2) && date[6] >= substr(beforeDate, 18, 2)) {
        isValid = 1;
      }

      print isValid;
    }')

    if [ $isBefore == 1 ]; then
      output=$(echo "$output" | grep -v "$date")
    fi
  done
}

listFunc(){
  echo "$output"
}

listCurrencyFunc(){
  local currencies=()
  local IFS=$'\n'

  for line in $output; do
    local isCurrency=1
    lastCurrency=$(echo $line | awk -F ';' '{printf "%s", $3}')

    for ((i=0; i<${#currencies[@]}; i++)); do
      if [ "$lastCurrency" == "${currencies[$i]}" ]; then
        isCurrency=0
        break
      fi
    done

    if [ $isCurrency == 1 ]; then
      currencies+=("$lastCurrency")
    fi

  done

  echo "${currencies[@]}" | tr ' ' '\n' | sort
}

statusFunc() {
  local currencies=()
  local currenciesValue=()
  local IFS=$'\n'

  for line in $output; do
    local isCurrency=1
    lastCurrency=$(echo "$line" | awk -F ';' '{printf "%s", $3}')
    lastValue=$(echo "$line" | awk -F ';' '{printf "%s", $4}')

    for ((i=0; i<${#currencies[@]}; i++)); do
      if [ "$lastCurrency" == "${currencies[$i]}" ]; then
        isCurrency=0
        currenciesValue[$i]=$(echo "${currenciesValue[$i]} + $lastValue" | bc)
        break
      fi
    done

    if [ $isCurrency == 1 ]; then
      currencies+=("$lastCurrency")
      currenciesValue+=("$lastValue")
    fi
  done

  local finalString=""
  for ((i=0; i<${#currencies[@]}; i++)); do
    finalString+="${currencies[$i]} : ${currenciesValue[$i]}\n"
  done

  finalString="${finalString%"\n"}"

  echo -e "$finalString" | sort
}

profitFunc() {
  local currencies=()
  local currenciesValue=()
  local IFS=$'\n'

  for line in $output; do
    local isCurrency=1
    lastCurrency=$(echo "$line" | awk -F ';' '{printf "%s", $3}')
    lastValue=$(echo "$line" | awk -F ';' '{printf "%s", $4}')

    for ((i=0; i<${#currencies[@]}; i++)); do
      if [ "$lastCurrency" == "${currencies[$i]}" ]; then
        isCurrency=0
        currenciesValue[$i]=$(echo "(${currenciesValue[$i]} + $lastValue)" | bc)
        break
      fi
    done

    if [ $isCurrency == 1 ]; then
      currencies+=("$lastCurrency")
      currenciesValue+=("$lastValue")
    fi
  done

  local finalString=""
  for ((i=0; i<${#currencies[@]}; i++)); do
    if [ "${currenciesValue[$i]}" \< 0 ]; then
        finalString+="${currencies[$i]} : ${currenciesValue[$i]}\n"
    else
        result=$(echo "scale=4; ${currenciesValue[$i]} * ((100 + ${margin}) / 100)" | bc)
        finalString+="${currencies[$i]} : $result\n"
    fi
  done

  finalString="${finalString%"\n"}"

  echo -e "$finalString" | sort
}

if [ "$#" -lt 2 ]; then
  exit 1
fi

for arg in "$@"; do
  if [ $lastFlag == 1 ]; then
    after=$arg
    lastFlag=0
    ((afterSet++))
    continue
  elif [ $lastFlag == 2 ]; then
    before=$arg
    lastFlag=0
    ((beforeSet++))
    continue
  elif [ $lastFlag == 3 ]; then
    currency="$arg ${currency[@]}"
    lastFlag=0
    continue
  fi

  setCommand $arg
  if [ $? == 0 ]; then
    continue
  fi

  setFilters $arg
  if [ $lastFlag != 0 ]; then
    continue
  fi

  if [ "$user" == "" ]; then
    user=$arg
  else
    files+=("$arg"$'\n')
  fi  
done

if [ "$user" == "" ]; then
  exit 1
fi

if [ "$commandSet" -gt 1 ]; then
  exit 1
fi

if [ "$afterSet" -gt 1 ]; then
  exit 1
fi

if [ "$beforeSet" -gt 1 ]; then
  exit 1
fi

if [ ${#files[@]} == 0 ]; then 
  exit 1
fi

IFS=$'\n'
for file in ${files[@]}; do
  if [ ! -e "$file" ]; then
    exit 1
  fi

  if echo "$file" | grep -q ".gz"; then
    output+=$(gzip -cd "$file")
  else
    output+=$(cat "$file" | tr -d '\0')$'\n'
  fi
done
IFS=$' '

filterUser
filterAfter
filterBefore
filterCurrency

case $command in
    list)
      listFunc
    ;;
    
    list-currency)
      listCurrencyFunc
    ;;

    status)
      statusFunc
    ;;

    profit)
      profitFunc
    ;;
esac